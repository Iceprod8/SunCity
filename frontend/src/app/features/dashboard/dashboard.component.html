<ng-container *ngIf="user(); else notLogged">
  <div class="page-container pb-12">
    <div class="bg-[#f6f1e9] border border-amber-100 rounded-3xl shadow-xl shadow-amber-100/40 p-4 md:p-6 space-y-6">
      <app-page-header
        title="Vue d'ensemble quotidienne"
        subtitle="Meteo, actus et activites autour de vous.">
      </app-page-header>

      <div class="grid gap-4 lg:grid-cols-3">
        <div id="weather" class="lg:col-span-2 relative overflow-hidden rounded-3xl bg-gradient-to-br from-amber-100 via-amber-50 to-amber-200 shadow-lg border border-amber-100">
          <div class="absolute w-56 h-56 bg-amber-300/60 rounded-full blur-3xl -left-10 -top-8"></div>
          <div class="absolute w-64 h-64 bg-orange-300/50 rounded-full blur-3xl right-10 bottom-0"></div>
          <div class="relative p-6 flex flex-col gap-4">
            <p class="text-sm text-amber-700">Votre energie du jour</p>
            <h2 class="text-xl font-semibold text-slate-900">
              {{ weatherIcon }} {{ selectedDateLabel }} · {{ selectedWeather?.condition || 'Pas de donnees pour cette date' }}
            </h2>
            <p class="text-sm text-slate-600">Mini {{ selectedWeather?.min ?? '--' }}°C · Maxi {{ selectedWeather?.max ?? '--' }}°C</p>
            <p *ngIf="!selectedWeather" class="text-sm text-slate-600">Aucune meteo trouvee pour cette date. Cliquez sur une autre journee du calendrier.</p>
            <div class="flex flex-col gap-2 text-sm text-slate-800">
              <div class="flex items-center gap-2">
                <span class="w-3 h-2 rounded-full bg-orange-400"></span> Conditions meteo chargees depuis le backend
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-2 rounded-full bg-amber-500"></span> Choisissez un jour du calendrier pour filtrer
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-2 rounded-full bg-slate-700"></span> Icones dynamiques selon la condition du jour
              </div>
            </div>
            <a routerLink="/weather" class="self-start text-sm font-semibold text-slate-900 hover:underline">Voir la meteo</a>
          </div>
        </div>

        <div class="bg-slate-900 text-white rounded-3xl shadow-lg p-5 flex flex-col gap-4 border border-slate-800">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-sm text-slate-300">Vos jours actifs</p>
              <h2 class="text-xl font-semibold">{{ monthLabel }}</h2>
            </div>
            <div class="px-3 py-1 rounded-full bg-slate-800 text-xs">Planning</div>
          </div>
          <div class="grid grid-cols-7 gap-2 text-sm">
            <div
              *ngFor="let day of trainingDays"
              class="aspect-square rounded-full grid place-items-center font-medium cursor-pointer transition hover:-translate-y-0.5"
              [ngClass]="{
                'bg-amber-300 text-slate-900 shadow ring-2 ring-amber-200 ring-offset-2 ring-offset-slate-900': day.state === 'current',
                'bg-slate-800 text-slate-100 border border-slate-700': day.state !== 'current',
                'ring-2 ring-amber-300 ring-offset-2 ring-offset-slate-900': selectedDate === day.date && day.state !== 'current'
              }"
              (click)="selectDate(day.date)"
              [title]="'Voir la meteo du ' + day.date">
              {{ day.day }}
            </div>
          </div>
          <div class="flex gap-4 text-xs text-slate-300">
            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-amber-300"></span> Aujourd'hui</div>
          </div>
        </div>
      </div>

      <div class="grid gap-4 lg:grid-cols-2" id="news">
        <div class="bg-white rounded-3xl shadow p-5 border border-amber-100">
          <div class="flex items-center justify-between mb-3">
            <div>
              <p class="text-sm text-amber-700">Actualites</p>
              <h3 class="text-lg font-semibold text-slate-900">Selection du jour</h3>
            </div>
            <a routerLink="/news" class="text-xs text-brand-700 hover:underline">Tout voir</a>
          </div>
          <ul class="space-y-2 text-sm text-slate-700">
            <li *ngFor="let a of news" class="p-3 rounded-xl bg-amber-50/60 border border-amber-100 shadow-sm">
              <p class="font-semibold text-slate-900">{{ a.title }}</p>
              <p class="text-xs text-slate-500">{{ a.publisher }} · {{ a.date }}</p>
            </li>
          </ul>
          <p *ngIf="!news.length" class="text-sm text-slate-500">Aucune actualite chargee.</p>
        </div>

        <div class="bg-white rounded-3xl shadow p-5 border border-amber-100" id="activities">
          <div class="flex items-center justify-between mb-3">
            <div>
              <p class="text-sm text-amber-700">Activites proches</p>
              <h3 class="text-lg font-semibold text-slate-900">A faire aujourd'hui</h3>
            </div>
            <a routerLink="/activities" class="text-xs text-brand-700 hover:underline">Explorer</a>
          </div>
          <ul class="space-y-2 text-sm text-slate-700">
            <li *ngFor="let x of activities" class="flex items-center justify-between p-3 rounded-xl bg-amber-50/60 border border-amber-100 shadow-sm">
              <div>
                <p class="font-semibold text-slate-900 leading-tight">{{ x.name }}</p>
                <p class="text-xs text-slate-500">{{ x.type }}</p>
              </div>
              <div class="text-right">
                <p class="text-sm font-semibold text-slate-900">{{ x.distanceKm }} km</p>
                <p class="text-xs text-slate-500">Score {{ x.popularity }}/100</p>
              </div>
            </li>
          </ul>
          <p *ngIf="!activities.length" class="text-sm text-slate-500">Aucune activite chargee.</p>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<ng-template #notLogged>
  <p class="page-container">Connectez-vous pour voir votre dashboard. <a routerLink="/login" class="text-brand-700 hover:underline">Connexion</a></p>
</ng-template>
